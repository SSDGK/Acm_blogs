# CF2165F Arctic Acquisition 题解
## [题目链接](https://codeforces.com/contest/2165/problem/F)

前置知识：扫描线，吉司机线段树。

题意：给你一个1到n的排列。定义一个数组是**锯齿状**的，当且仅当其存在至少一个长度为5的子序列$a$，满足$a_2 < a_1 < a_4 < a_3 < a_5$。问你原数组有多少锯齿状的子数组。

显然，如果有任意一个区间$[l, r]$对应的子数组满足条件，那么所有包含$[l, r]$区间的更大的区间也一定满足条件，我们不妨先来尝试找出这些极小区间，那么这些极小区间的左端点一定是合法子序列的第一个数所在的位置，右端点一定是第五个数所在的位置。


首先我们先把这个子序列大概的结构画出来，图中我们用点的高低来表示数的大小，点的左右分布来表示其在原数组中的位置关系：
![结构](http://img.wuyi.host/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-11-25%20164229.png)

在这里我们用$p$来表示这个子序列中的数在原数组中的位置，比如我们现在把$a_1$定在$i$，$p_1$就等于$i$。并且记$val_i$为原数组中第$i$个数。
首先我们可以枚举$a_1$，假设我们固定了一个$a_2$，那么345就需要满足：$a_4 > a_1$且$p_3 > p_2$，也就是下图中红色和绿色相交的右上部分。
![](http://img.wuyi.host/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-11-25%20165355.png)
那么我们这里就可以有一个显然的观察，就是345的大小完全与$a_2$无关，而$p_2$越小，红线越靠左，合法的345一定越多。所以在我们固定了$a_1$之后，$a_2$一定是$a_1$右边第一个大于$a_1$的数，也就是说明$a_1$和$a_2$可以看作一个整体，$a_1$固定$a_2$也一定固定。

接下来我们来考虑怎么处理345这部分，类似于12，我们也把345看作一个整体，这里我们记$p_3 = l, p_4 = i, p_5 = r$。那么如果我们能事先找到所有$\{l, i, r\}$，那么在枚举$a_1$的过程中，我们只需要找到满足$l > p_2, val_i > a_1$中最小的$r$，那么$[p_1, r]$一定是一个合法区间。

我们接下来就来讨论如何处理出所有$\{l, i, r\}$，我们首先枚举$i$。这里有一个非常重要的结论，也是这道题的核心难点：$i$固定时，$r$的位置一定是在$i$右边第一个大于$val_i$的数的位置。

我们采用反证的思想，如果我们选的$r$不是第一个大于$val_i$的数的位置会怎么样。那么我们用$r_w$表示现在的选的$r$，$r_b$表示满足原条件的$r$，那么我们要关注的情况有如下两种：
<table>
    <tr>
    <td><img src="http://img.wuyi.host/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-11-25%20173512.png" alt="1" width="300"></td>
    <td><img src="http://img.wuyi.host/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-11-25%20173612.png" alt="2" width="300"></td>
    </tr>
</table>

分别是$val_l < val_{r_b}$和$val_l > val_{r_b}$（注意我们不关心$val_{r_b}$和$val_{r_w}$的大小关系）。

- 对于第一种情况，我们选择$r_b$，此时$r$更小并且依旧满足条件，一定比选择$r_w$更优。
- 对于第二种情况，尽管我们选择$r_b$会直接导致$\{l, i, r_b\}$直接不满足条件，但是当我们将$i$遍历到$r_b$位置时，我们可以将$\{l, r_b, r_w\}$作为一个更优的$\{l, i, r\}$，因为这个在$r$不变的情况下，$val_i$的值变得更大了，这个三元组一定更容易去满足我们遍历$a_1$时要找的那些三元组的条件。回到一开始的$i$，我们这时选择$r_b$作为$r$，可以直接排除掉一个不优的选项。

这下我们就能预处理出所有345三元组了，只要枚举$i$，$r$就固定，$l$直接选择在$i$左边第一个值位于$(val_i, val_r)$之间的位置就好。所以每个位置产生的三元组最多就一个，单个的处理利用值域线段树$O(logn)$就能搞定。

接下来我们枚举$p_1$，将$a_1$的值放到其对应的$p_2$的集合里边，这下对于一个$p_2$，我们就能找到所有合法的$a_1$，方便我们做扫描线统计答案。
这下我们有了所有$\{l, i, r\}$，我们对$p_2$从大到小做扫描线，每次把满足$l > p_2$的所有三元组用于将线段树上$val_i$的位置的数更新为$r$。然后我们遍历$p_2$对应的所有$a_1$，依次找线段树上大于$a_1$的位置中最小的值，也就是最小的$r$，此时我们就找到了一个合法区间$[p_1, r]$。
那么我们如何统计答案呢，我们可以对每个固定的左端点，找到合法的最小的右端点。那么上述的合法区间$[p_1, r]$就可以对所有左端点小于等于$p_1$的更新右端点为$r$，这是一个$checkmin$操作，我们可以用吉司机线段树来维护。
那么这道题就顺利的做完了。这道题数据量很大，而扫描线线段树的常数非常大，所以除了最后的吉司机线段树外，我都使用了zkw线段树来降低常数，最后跑了1358ms，时限有5s，轻松通过。