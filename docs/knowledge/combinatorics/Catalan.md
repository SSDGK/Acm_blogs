# 卡特兰数

卡特兰数一个常在组合数学场景中出现的一个数列，常与路径，栈，括号串等计数模型有关。

卡特兰数的四个公式：

- $f(n) = C_{2n}^n - C_{2n}^{n - 1}$
- $f(n) = C_{2n}^n / (n + 1)$
- $f(n) = f(n - 1) * (4n - 2) / (n + 1)$
- $f(n) = \sum_{i = 0}^{n-1}f(i)*f(n - i - 1)$

公式1和4最为常用，公式4虽然复杂度较高，但是可以规避逆元计算，常用于处理模数不为质数的情况。

其前几项为（从第0项开始）：1, 1, 2, 5, 14, 42, 132, 429, 1430, 4862, 16796, 58786, 208012, 742900, 2674440, 9694845, 35357670, 129644790, 477638700, 1767263190, 6564120420, 24466267020, 91482563640, 343059613650, 1289904147324, 4861946401452………

一个常见的模型是括号串模型，长度为2n的合法括号串数量就为$f(n)$个。

## 例题1（模板）：[P1044 栈](https://www.luogu.com.cn/problem/P1044)
给定一个入栈序列，问有多少种合法的出栈序列。
给入栈定为左括号，出栈定为右括号，实际上答案就是长度为2n的合法括号串数量。

三倍经验，也就是对应的经典模型：

[P1976 鸡蛋饼](https://www.luogu.com.cn/problem/P1976)，[P1722 矩阵 II](https://www.luogu.com.cn/problem/P1722)

## 例题2：[P3200 有趣的数列](https://www.luogu.com.cn/problem/P3200)
题意：给你n表示要求满足以下条件的2n的排列数量：

- 奇数位上的数递增
- 偶数位上的数递增
- 每个奇数位上的数都比他右边第一个偶数位上的数小

由上条件我们发现，每个偶数位上的数都比它左边所有数大。然后依次从1到2n放数，我们可以发现当前数必须放在第一个没放数的奇数位上或者偶数位上，否则接下来的数放到前边一定会不合法。

假设我们现在放了$x$个数，其中放在奇数位上$x_1$个，放在偶数位上$x_2$个。如果$x_2 > x_1$，那么$x_2 > \frac{x}{2}$，而最后一个放了数的偶数位下标是$2x_2$，所以有$2x_2 > x$，这与每个偶数位上的数都比它左边所有数大这一条件冲突。

所以合法的排列一定是从1到2n放数，任意时候放在奇数位上的数要不少于偶数位上的数，那么这就类似于括号串模型，答案就是卡特兰数第n项。

下面来到这道题的关键，这题数据量$n \leqslant 10^6$且模数$p$不一定是质数，那么没法用公式4来算，用前三个公式的话直接算会出现无法计算逆元的问题。那么接下来我们通过因子计数法来规避逆元计算。

首先我们使用公式：$f(n) = C_{2n}^n / (n + 1)$，展开组合数化简得$\frac{(n+2)(n+3)...(2n - 1)2n}{2*3*...*n }$。然后我们记录一个因子计数表，出现在分子中的给词频标为1，分母中的标为-1：

|1|2|3|...|n - 1|n|...|2n - 1|2n|
|---|---|---|---|---|---|---|---|---|
|0|-1|-1|...|-1|-1|...|1|1|

我们从大到小，如果当前数词频不为0，我们就使用这个数的最小质因子来分解它，并将词频分配出去。例如：

|1|2|3|4|5|6|7|8|
|-|-|-|-|-|-|-|-|
|0|-1|-1|-1|1|1|1|1|

遍历到8时，8的最小质因子是2，那么可以分解为$2^3 * 1$，所以可以给2增加3个词频，1增加1个词频。

|1|2|3|4|5|6|7|8|
|-|-|-|-|-|-|-|-|
|1|2|-1|-1|1|1|1|1|

这样实际上就是约分的过程，由于答案是整数，最后剩下的一定所有数词频非负，使用快速幂乘起来即可。

## 例题3：[P3978 概率论](https://www.luogu.com.cn/problem/P3978)

题意：问n个节点形成的二叉树中，叶节点数量的期望是多少。

首先n个节点形成的二叉树有$f(n)$种，也就是卡特兰数。然后往一棵n个节点的树上插入一个叶节点的位置有n+1个，每个位置都能产生贡献，所以n个节点形成的所有二叉树中叶节点总数为$g(n)=n*f(n-1)$，所以答案为$\frac{g(n)}{f(n)}=\frac{n*(n+1)}{4n-2}$